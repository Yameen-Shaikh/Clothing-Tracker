{% extends 'production_tracker/base.html' %}

{% block content %}
    <h1>Manage Pipeline Stages for Order ID: {{ order.id }}</h1>
    <p><strong>Customer:</strong> {{ order.customer.name }}</p>

    <h2>Add New Stage</h2>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="button">Add Stage</button>
    </form>

    <h2>Existing Stages</h2>
    <table>
        <thead>
            <tr>
                <th>Stage</th>
                <th>Assigned Vendor</th>
                <th>Status</th>
                <th>Note</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for stage in order_stages %}
                <tr>
                    <td>{{ stage.stage.name }}</td>
                    <td>{{ stage.assigned_vendor.name|default:"N/A" }}</td>
                    <td>{{ stage.status }}</td>
                    <td>{{ stage.note|default:"N/A" }}</td>
                    <td>
                        <form action="{% url 'update_order_stage' stage.pk %}" method="post" style="display:inline;" class="update-form">
                            {% csrf_token %}
                            <select name="status" class="status-select">
                                {% for value, label in stage.STATUS_CHOICES %}
                                    <option value="{{ value }}" {% if stage.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <select name="assigned_vendor" class="vendor-select">
                                {% for vendor in vendors %}
                                    <option value="{{ vendor.pk }}" {% if stage.assigned_vendor.pk == vendor.pk %}selected{% endif %}>{{ vendor.name }}</option>
                                {% endfor %}
                            </select><br>
                            <input type="hidden" name="note" class="note-input" value="{{ stage.note|default:"" }}">
                            <br><button type="submit" class="button">Update</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <br><a href="{% url 'order_detail' order.pk %}" class="button">Back to Order Detail</a>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stageSelect = document.getElementById('id_stage');
    const vendorSelect = document.getElementById('id_assigned_vendor');

    stageSelect.addEventListener('change', function() {
        const stageId = this.value;
        if (stageId) {
            fetch(`/vendors/by-stage/${stageId}/`)
                .then(response => response.json())
                .then(data => {
                    vendorSelect.innerHTML = '<option value="">-- Select a vendor --</option>';
                    data.forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor.id;
                        option.textContent = vendor.name;
                        vendorSelect.appendChild(option);
                    });
                });
        } else {
            vendorSelect.innerHTML = '<option value="">-- Select a vendor --</option>';
        }
    });

    document.querySelectorAll('.status-select, .vendor-select').forEach(select => {
        select.addEventListener('change', function() {
            const noteInput = this.closest('.update-form').querySelector('.note-input');
            const newNote = prompt("Add a note:", noteInput.value);
            if (newNote !== null) {
                noteInput.value = newNote;
            }
        });
    });
});
</script>
{% endblock %}