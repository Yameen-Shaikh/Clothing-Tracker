{% extends 'production_tracker/base.html' %}

{% block content %}
    <h1>{{ title }}</h1>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <p>
            <label for="customer-search-input">Customer:</label>
            <input type="text" id="customer-search-input" name="customer_name" placeholder="Search for a customer by name or phone..." value="{{ request.POST.customer_name }}">
            <div id="customer-search-results"></div>
        </p>
        <input type="hidden" name="customer" id="selected-customer-id" value="{{ request.POST.customer }}">

        <p>
            <label for="measurement-select">Measurement:</label>
            <select name="measurement" id="measurement-select" {% if not request.POST.customer %}disabled{% endif %}>
                <option value="">-- Select a Measurement --</option>
            </select>
        </p>

        {{ form.as_p }}
        <button type="submit" class="button">Create Order</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const customerSearchInput = document.getElementById('customer-search-input');
            const customerSearchResults = document.getElementById('customer-search-results');
            const selectedCustomerId = document.getElementById('selected-customer-id');

            const measurementSelect = document.getElementById('measurement-select');

            function fetchMeasurements(customerId, selectedMeasurementId = null) {
                if (customerId) {
                    fetch(`/api/measurement-search/?customer_id=${customerId}`)
                        .then(response => response.json())
                        .then(data => {
                            measurementSelect.innerHTML = '<option value="">-- Select a Measurement --</option>';
                            data.forEach(measurement => {
                                const option = document.createElement('option');
                                option.value = measurement.id;
                                option.textContent = `${measurement.type} (ID: ${measurement.id})`;
                                if (selectedMeasurementId && measurement.id == selectedMeasurementId) {
                                    option.selected = true;
                                }
                                measurementSelect.appendChild(option);
                            });
                            measurementSelect.disabled = false;
                        });
                } else {
                    measurementSelect.innerHTML = '<option value="">-- Select a Measurement --</option>';
                    measurementSelect.disabled = true;
                }
            }

            // Pre-populate customer and measurement fields on initial load or validation error
            const initialCustomerId = selectedCustomerId.value || "{{ selected_customer_id }}";
            const initialMeasurementId = "{{ request.POST.measurement }}" || "{{ selected_measurement_id }}";

            if (initialCustomerId) {
                selectedCustomerId.value = initialCustomerId;
                fetchMeasurements(initialCustomerId, initialMeasurementId);
            }

            customerSearchInput.addEventListener('keyup', function() {
                const query = customerSearchInput.value;
                if (query.length > 2) {
                    fetch(`/api/customer-search/?query=${query}`)
                        .then(response => response.json())
                        .then(data => {
                            customerSearchResults.innerHTML = '';
                            data.forEach(customer => {
                                const customerDiv = document.createElement('div');
                                customerDiv.innerHTML = `${customer.name} - ${customer.phone}`;
                                customerDiv.style.cursor = 'pointer';
                                customerDiv.addEventListener('click', function() {
                                    selectedCustomerId.value = customer.id;
                                    customerSearchInput.value = `${customer.name} - ${customer.phone}`;
                                    customerSearchResults.innerHTML = '';
                                    fetchMeasurements(customer.id); // Fetch measurements for selected customer
                                });
                                customerSearchResults.appendChild(customerDiv);
                            });
                        });
                } else {
                    selectedCustomerId.value = '';
                    customerSearchResults.innerHTML = '';
                    fetchMeasurements(null); // Clear measurements if no customer selected
                }
            });
        });
    </script>
{% endblock %}