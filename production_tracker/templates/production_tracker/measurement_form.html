{% extends 'production_tracker/base.html' %}

{% block content %}
    <h1>{{ title|default:"Create Measurement" }}</h1>

    <form method="post">
        {% csrf_token %}
        <p>
            <label for="customer-search-input">Customer:</label>
            {% if read_only %}
                <input type="text" value="{% if form.instance.customer %}{{ form.instance.customer.name }} - {{ form.instance.customer.phone }}{% endif %}" readonly class="form-control">
            {% else %}
                <input type="text" id="customer-search-input" placeholder="Search for a customer by name or phone..." value="{% if form.instance.customer %}{{ form.instance.customer.name }} - {{ form.instance.customer.phone }}{% endif %}" class="form-control">
                <div id="customer-search-results"></div>
            {% endif %}
        </p>
        <input type="hidden" name="customer" id="selected-customer-id" value="{% if form.instance.customer %}{{ form.instance.customer.id }}{% endif %}">

        <div class="form-group">
            {{ form.measurement_type.label_tag }}
            {{ form.measurement_type }}
        </div>

        {% for field in form %}
            {% if field.name != 'customer' and field.name != 'measurement_type' %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                    {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                    {% if field.errors %}
                        <div class="alert alert-danger">{{ field.errors }}</div>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}

        {% if not read_only %}
            <button type="submit" class="button">Create</button>
        {% endif %}
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const customerSearchInput = document.getElementById('customer-search-input');
            const customerSearchResults = document.getElementById('customer-search-results');
            const selectedCustomerId = document.getElementById('selected-customer-id');

            customerSearchInput.addEventListener('keyup', function() {
                const query = customerSearchInput.value;
                if (query.length > 2) {
                    fetch(`/api/customer-search/?query=${query}`)
                        .then(response => response.json())
                        .then(data => {
                            customerSearchResults.innerHTML = '';
                            data.forEach(customer => {
                                const customerDiv = document.createElement('div');
                                customerDiv.innerHTML = `${customer.name} - ${customer.phone}`;
                                customerDiv.style.cursor = 'pointer';
                                customerDiv.classList.add('customer-search-item');
                                customerDiv.addEventListener('click', function() {
                                    selectedCustomerId.value = customer.id;
                                    customerSearchInput.value = `${customer.name} - ${customer.phone}`;
                                    customerSearchResults.innerHTML = '';
                                });
                                customerSearchResults.appendChild(customerDiv);
                            });
                        });
                } else {
                    selectedCustomerId.value = '';
                    customerSearchResults.innerHTML = '';
                }
            });
        });
    </script>
{% endblock %}