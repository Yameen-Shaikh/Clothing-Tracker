{% extends 'production_tracker/base.html' %}
{% block content %}
    <h1>Search and Edit Customer</h1>
    <form class="filter-form" method="get">
        {% csrf_token %}
        <div class="filter-group">
            <label for="search_name">Search customer:</label>
            <input type="text" id="search_name" name="search_name" value="{{ search_name }}" placeholder="Search by name or phone...">
            <input type="hidden" id="selected-customer-id" name="selected_customer_id" value="">
            <div id="customer-search-results" class="custom-search-results"></div>
        </div>
        <div class="filter-group">
            <label for="search_gender">Gender:</label>
            <select id="search_gender" name="search_gender">
                <option value="">All</option>
                {% for value, label in gender_choices %}
                    <option value="{{ value }}" {% if search_gender == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="search_address">Address:</label>
            <input type="text" id="search_address" name="search_address" value="{{ search_address }}" placeholder="Search by address...">
        </div>
        <button type="submit" class="button">Search</button>
    </form>

    

    <div class="customer-results-table">
        {% if customers %}
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Gender</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cust in customers %}
                        <tr>
                            <td>{{ cust.name }}</td>
                            <td>{{ cust.email }}</td>
                            <td>{{ cust.phone }}</td>
                            <td>{{ cust.address }}</td>
                            <td>{{ cust.gender }}</td>
                            <td>
                                <a href="{% url 'customer_search_detail' %}?customer_id={{ cust.id }}&view_only=true" class="button">View</a>
                                <a href="{% url 'customer_search_detail' %}?customer_id={{ cust.id }}" class="button">Edit</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            {% if search_name or search_gender or search_address %}
                <p>No customers found for your search criteria.</p>
            {% endif %}
        {% endif %}
    </div>

    {% if customer %}
        <div id="customer-details-section">
            <h2>{% if view_only %}View Customer Details{% else %}Edit Customer Details{% endif %}</h2>
            <form method="post" id="customer-detail-form">
                {% csrf_token %}
                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                {{ form.as_p }}
                {% if not view_only %}
                    <button type="submit" class="button">Save Changes</button>
                {% endif %}
            </form>
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchNameInput = document.getElementById('search_name');
    const customerSearchResults = document.getElementById('customer-search-results');
    const customerDetailsSection = document.getElementById('customer-details-section');

    function loadCustomerDetails(customerId) {
        if (customerId) {
            window.location.href = `{% url 'customer_search_detail' %}?customer_id=${customerId}`;
        } else {
            customerDetailsSection.style.display = 'none';
        }
    }

    customerSearchResults.querySelectorAll('div[data-customer-id]').forEach(div => {
        div.addEventListener('click', function() {
            const customerId = this.dataset.customerId;
            loadCustomerDetails(customerId);
        });
    });

    searchNameInput.addEventListener('keyup', function() {
        const query = searchNameInput.value;
        if (query.length > 2) {
            fetch(`/api/customer-search/?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    customerSearchResults.innerHTML = '';
                    data.forEach(customer => {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.innerHTML = `${customer.name} - ${customer.phone}`;
                        suggestionDiv.style.cursor = 'pointer';
                        suggestionDiv.addEventListener('click', function() {
                            searchNameInput.value = customer.name;
                            document.getElementById('selected-customer-id').value = customer.id; // Set the hidden input value
                            customerSearchResults.innerHTML = '';
                        });
                        customerSearchResults.appendChild(suggestionDiv);
                    });
                });
        } else {
            customerSearchResults.innerHTML = '';
        }
    });

    // Clear suggestions when the form is submitted
    document.querySelector('.filter-form').addEventListener('submit', function() {
        customerSearchResults.innerHTML = '';
    });

    const successMessage = "{{ success_message|escapejs }}";
    if (successMessage && successMessage !== 'None') {
        alert(successMessage);
    }
});
</script>
{% endblock %}