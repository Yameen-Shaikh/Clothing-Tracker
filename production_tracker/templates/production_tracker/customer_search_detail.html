{% extends 'production_tracker/base.html' %}
{% block content %}
    <h1>Search and Edit Customer</h1>
    <form class="filter-form" method="get">
        <div class="filter-group">
            <label for="search_name">Search customer:</label>
            <input type="text" id="search_name" name="search_name" value="{{ search_name }}" placeholder="Search by name or phone...">
            <div id="customer-name-suggestions" class="custom-search-results"></div>
        </div>
        <div class="filter-group">
            <label for="search_gender">Gender:</label>
            <select id="search_gender" name="search_gender">
                <option value="">All</option>
                {% for value, label in gender_choices %}
                    <option value="{{ value }}" {% if search_gender == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="search_address">Address:</label>
            <input type="text" id="search_address" name="search_address" value="{{ search_address }}" placeholder="Search by address...">
        </div>
        <button type="submit">Search</button>
    </form>

    

    <div id="customer-search-results" class="custom-search-results">
        {% for cust in customers %}
            <div data-customer-id="{{ cust.id }}">{{ cust.name }} - {{ cust.phone }}</div>
        {% empty %}
            {% if search_name or search_gender or search_address %}
                <p>No customers found for your search criteria.</p>
            {% endif %}
        {% endfor %}
    </div>

    <input type="hidden" id="selected-customer-id" value="{% if customer %}{{ customer.id }}{% endif %}>
    
    <div id="customer-details-section" {% if not customer %}style="display:none;"{% endif %}>
        <form method="post" id="customer-detail-form">
            {% csrf_token %}
            <input type="hidden" name="customer_id" value="{{ customer.id }}">
            {{ form.as_p }}
            <button type="submit">Save Changes</button>
        </form>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchNameInput = document.getElementById('search_name');
    const customerNameSuggestions = document.getElementById('customer-name-suggestions');
    const customerSearchResults = document.getElementById('customer-search-results');
    const customerDetailsSection = document.getElementById('customer-details-section');

    function loadCustomerDetails(customerId) {
        if (customerId) {
            window.location.href = `{% url 'customer_search_detail' %}?customer_id=${customerId}`;
        } else {
            customerDetailsSection.style.display = 'none';
        }
    }

    customerSearchResults.querySelectorAll('div[data-customer-id]').forEach(div => {
        div.addEventListener('click', function() {
            const customerId = this.dataset.customerId;
            loadCustomerDetails(customerId);
        });
    });

    searchNameInput.addEventListener('keyup', function() {
        const query = searchNameInput.value;
        if (query.length > 2) {
            fetch(`/api/customer-search/?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    customerNameSuggestions.innerHTML = '';
                    data.forEach(customer => {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.innerHTML = `${customer.name} - ${customer.phone}`;
                        suggestionDiv.style.cursor = 'pointer';
                        suggestionDiv.addEventListener('click', function() {
                            searchNameInput.value = customer.name;
                            customerNameSuggestions.innerHTML = '';
                        });
                        customerNameSuggestions.appendChild(suggestionDiv);
                    });
                });
        } else {
            customerNameSuggestions.innerHTML = '';
        }
    });

    // Clear suggestions when the form is submitted
    document.querySelector('.filter-form').addEventListener('submit', function() {
        customerNameSuggestions.innerHTML = '';
    });

    const successMessage = "{{ success_message|escapejs }}";
    if (successMessage && successMessage !== 'None') {
        alert(successMessage);
    }
});
</script>
{% endblock %}