{% extends 'production_tracker/base.html' %}

{% block content %}
    <h1>{{ title }}</h1>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <p>
            <label for="customer-search-input">Customer:</label>
            <input type="text" id="customer-search-input" placeholder="Search for a customer by name or phone...">
            <div id="customer-search-results"></div>
        </p>
        <input type="hidden" name="customer" id="selected-customer-id">

        <p>
            <label for="measurement-select">Measurement:</label>
            <select name="measurement" id="measurement-select" disabled>
                <option value="">-- Select a Measurement --</option>
            </select>
        </p>

        {{ form.as_p }}
        <button type="submit" class="button">Create Order</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const customerSearchInput = document.getElementById('customer-search-input');
            const customerSearchResults = document.getElementById('customer-search-results');
            const selectedCustomerId = document.getElementById('selected-customer-id');

            const measurementSelect = document.getElementById('measurement-select');

            function fetchMeasurements(customerId, selectedMeasurementId = null) {
                if (customerId) {
                    fetch(`/api/measurement-search/?customer_id=${customerId}`)
                        .then(response => response.json())
                        .then(data => {
                            measurementSelect.innerHTML = '<option value="">-- Select a Measurement --</option>';
                            data.forEach(measurement => {
                                const option = document.createElement('option');
                                option.value = measurement.id;
                                option.textContent = `${measurement.type} (ID: ${measurement.id})`;
                                measurementSelect.appendChild(option);
                            });
                            measurementSelect.disabled = false;
                            if (selectedMeasurementId) {
                                measurementSelect.value = selectedMeasurementId;
                            }
                        });
                } else {
                    measurementSelect.innerHTML = '<option value="">-- Select a Measurement --</option>';
                    measurementSelect.disabled = true;
                }
            }

            // Pre-populate customer and measurement fields if data is available (for edit view)
            const initialCustomerId = "{{ selected_customer_id }}";
            const initialCustomerName = "{{ selected_customer_name }}";
            const initialMeasurementId = "{{ selected_measurement_id }}";

            if (initialCustomerId && initialCustomerName) {
                selectedCustomerId.value = initialCustomerId;
                customerSearchInput.value = initialCustomerName;
                fetchMeasurements(initialCustomerId, initialMeasurementId);
            } else {
                // Initial state: measurement dropdown disabled if no customer is pre-selected
                measurementSelect.disabled = true;
            }

            customerSearchInput.addEventListener('keyup', function() {
                const query = customerSearchInput.value;
                if (query.length > 2) {
                    fetch(`/api/customer-search/?query=${query}`)
                        .then(response => response.json())
                        .then(data => {
                            customerSearchResults.innerHTML = '';
                            data.forEach(customer => {
                                const customerDiv = document.createElement('div');
                                customerDiv.innerHTML = `${customer.name} - ${customer.phone}`;
                                customerDiv.style.cursor = 'pointer';
                                customerDiv.addEventListener('click', function() {
                                    selectedCustomerId.value = customer.id;
                                    customerSearchInput.value = `${customer.name} - ${customer.phone}`;
                                    customerSearchResults.innerHTML = '';
                                    fetchMeasurements(customer.id); // Fetch measurements for selected customer
                                });
                                customerSearchResults.appendChild(customerDiv);
                            });
                        });
                } else {
                    selectedCustomerId.value = '';
                    customerSearchResults.innerHTML = '';
                    fetchMeasurements(null); // Clear measurements if no customer selected
                }
            });
        });
    </script>
{% endblock %}