{% extends 'production_tracker/base.html' %} {% block content %}
<div
  class="container mt-4"
  id="invoice-container"
  data-invoice-id="{{ invoice.id }}"
  data-add-orders-url="{% url 'add_orders_to_invoice' invoice.id %}"
  data-remove-order-url="{% url 'remove_order_from_invoice' invoice.id %}"
>
  <div class="card">
    <div class="card-header">
      <h2>{{ title }}</h2>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.total_amount.id_for_label }}"
                >Total Amount: ₹</label
              >
              {{ form.total_amount }}
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.paid_on_date.id_for_label }}"
                >Paid on Date:</label
              >
              {{ form.paid_on_date }}
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.paid_amount.id_for_label }}"
                >Paid Amount: ₹</label
              >
              {{ form.paid_amount }}
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Balance:</label>
              <p id="balance_p">₹{{ invoice.balance }}</p>
            </div>
          </div>
        </div>
        <button type="submit" class="button">Update Invoice</button>
      </form>

      <hr />

      <h3>Associated Orders</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Amount</th>
            <th>Customer Name</th>
            <th>Mobile Number</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for order in invoice.orders.all %}
          <tr>
            <td>
              <a href="{% url 'order_detail' order.id %}">{{ order.id }}</a>
            </td>
            <td>₹{{ order.amount_in_rupees }}</td>
            <td>{{ order.customer.name }}</td>
            <td>{{ order.customer.phone }}</td>
            <td>
              <button
                type="button"
                class="button remove-order"
                data-order-id="{{ order.id }}"
              >
                Remove
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5">No orders associated with this invoice.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <hr />

      <h3>Add New Orders</h3>
      <div class="form-group">
        <label for="order_search">Search Orders to Add:</label>
        <input
          type="text"
          id="order_search"
          class="form-control"
          placeholder="Search by Order ID or Customer Name/Phone..."
        />
        <div id="order_suggestions" class="custom-search-results"></div>
      </div>
      <div class="mt-2">
        <strong>Selected to add:</strong>
        <div id="selected_orders_display" class="d-flex flex-wrap">
          <span class="text-muted">None</span>
        </div>
      </div>
      <button type="button" id="add_selected_orders" class="button mt-2">
        Add Selected Orders
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const invoiceContainer = document.getElementById("invoice-container");
    const invoiceId = invoiceContainer.dataset.invoiceId;
    const addOrdersUrl = invoiceContainer.dataset.addOrdersUrl;
    const removeOrderUrl = invoiceContainer.dataset.removeOrderUrl;
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    const orderSearchInput = document.getElementById("order_search");
    const orderSuggestionsDiv = document.getElementById("order_suggestions");
    const addSelectedOrdersBtn = document.getElementById("add_selected_orders");
    const selectedOrdersDisplay = document.getElementById("selected_orders_display");
    const totalAmountEl = document.querySelector("[name='total_amount']");
    const paidAmountEl = document.querySelector("[name='paid_amount']");
    const balanceEl = document.querySelector('#balance_p');
    const ordersTableBody = document.querySelector('table tbody');

    let selectedOrders = new Map();

    function updateSelectedOrdersDisplay() {
      selectedOrdersDisplay.innerHTML = "";
      if (selectedOrders.size === 0) {
        selectedOrdersDisplay.innerHTML = '<span class="text-muted">None</span>';
        return;
      }
      selectedOrders.forEach((text, id) => {
        const pill = document.createElement("span");
        pill.className = "badge badge-primary mr-2 mb-2 p-2";
        pill.textContent = text;
        selectedOrdersDisplay.appendChild(pill);
      });
    }

    orderSearchInput.addEventListener("keyup", function () {
      const query = orderSearchInput.value;
      if (query.length > 2) {
        fetch(`/api/order-search/?query=${query}`)
          .then((response) => response.json())
          .then((data) => {
            orderSuggestionsDiv.innerHTML = "";
            data.forEach((order) => {
              const suggestionDiv = document.createElement("div");
              const displayText = `${order.id} - ${order.customer_name} (₹${order.amount})`;
              suggestionDiv.innerHTML = displayText;
              suggestionDiv.style.cursor = "pointer";
              suggestionDiv.classList.add("list-group-item", "list-group-item-action");

              suggestionDiv.addEventListener("click", function () {
                selectedOrders.set(order.id.toString(), displayText);
                updateSelectedOrdersDisplay();
                orderSearchInput.value = "";
                orderSuggestionsDiv.innerHTML = "";
              });
              orderSuggestionsDiv.appendChild(suggestionDiv);
            });
          });
      } else {
        orderSuggestionsDiv.innerHTML = "";
      }
    });

    addSelectedOrdersBtn.addEventListener("click", function () {
      const selectedOrderIds = Array.from(selectedOrders.keys());
      if (selectedOrderIds.length > 0) {
        fetch(addOrdersUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({ order_ids: selectedOrderIds }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              totalAmountEl.value = data.new_total_amount;
              balanceEl.innerText = `₹${data.new_balance}`;
              selectedOrders.clear();
              updateSelectedOrdersDisplay();
              fetchAndRenderOrders();
            } else {
              alert("Error adding orders: " + data.message);
            }
          })
          .catch((error) => console.error("Error:", error));
      } else {
        alert("Please select orders to add.");
      }
    });

    function fetchAndRenderOrders() {
        fetch(`/invoices/${invoiceId}/orders/`)
            .then(response => response.json())
            .then(data => {
                ordersTableBody.innerHTML = "";
                if (data.length === 0) {
                    ordersTableBody.innerHTML = '<tr><td colspan="5">No orders associated with this invoice.</td></tr>';
                    return;
                }
                data.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="${order.order_detail_url}">${order.id}</a></td>
                        <td>₹${order.amount_in_rupees}</td>
                        <td>${order.customer_name}</td>
                        <td>${order.customer_phone}</td>
                        <td>
                            <button type="button" class="button remove-order" data-order-id="${order.id}">Remove</button>
                        </td>
                    `;
                    ordersTableBody.appendChild(row);
                });
                attachRemoveEventListeners();
            });
    }

    function attachRemoveEventListeners() {
        document.querySelectorAll(".remove-order").forEach((button) => {
            button.addEventListener("click", function () {
                const orderId = this.dataset.orderId;
                if (confirm(`Are you sure you want to remove Order ${orderId} from this invoice?`)) {
                    fetch(removeOrderUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                        body: JSON.stringify({ order_id: orderId }),
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            totalAmountEl.value = data.new_total_amount;
                            balanceEl.innerText = `₹${data.new_balance}`;
                            fetchAndRenderOrders();
                        } else {
                            alert("Error removing order: " + data.message);
                        }
                    })
                    .catch((error) => console.error("Error:", error));
                }
            });
        });
    }

    paidAmountEl.addEventListener('keyup', function() {
        const totalAmount = parseFloat(totalAmountEl.value) || 0;
        const paidAmount = parseFloat(paidAmountEl.value) || 0;
        const balance = totalAmount - paidAmount;
        balanceEl.innerText = `₹${balance.toFixed(2)}`;
    });

    attachRemoveEventListeners();
    fetchAndRenderOrders();
  });
</script>
{% endblock %}
